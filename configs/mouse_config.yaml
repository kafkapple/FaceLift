# =============================================================================
# Mouse-FaceLift Configuration
# Adapted from FaceLift GS-LRM for mouse multi-view reconstruction
# =============================================================================
profile: false
debug: false

# =============================================================================
# Model Configuration
# =============================================================================
model:
  class_name: gslrm.model.gslrm.GSLRM

  # Image processing settings
  image_tokenizer:
    image_size: 512
    patch_size: 8
    in_channels: 9  # 3 RGB + 3 direction + 3 Reference

  # Transformer architecture
  transformer:
    d: 1024
    d_head: 64
    n_layer: 24

  # Gaussian splatting configuration
  gaussians:
    n_gaussians: 2  # 12288
    sh_degree: 0

    upsampler:
      upsample_factor: 1

  # Model behavior flags
  add_refsrc_marker: false
  hard_pixelalign: true
  use_custom_plucker: true
  clip_xyz: true

# =============================================================================
# Training Configuration
# =============================================================================
training:
  # Training runtime settings
  runtime:
    use_tf32: true
    use_amp: true
    amp_dtype: "bf16"
    torch_compile: false
    grad_accum_steps: 1
    grad_clip_norm: 1.0
    grad_checkpoint_every: 1

  # Dataset configuration for mouse data
  dataset:
    dataset_path: "data_mouse/data_mouse_train.txt"

    # View configuration: 6 views total
    # 1 input view -> reconstruct all 6 views
    maximize_view_overlap: false  # Use all views equally
    num_views: 6               # Total views per sample
    num_input_views: 1         # Single input view for inference
    target_has_input: true     # Include input in target

    # Data preprocessing
    normalize_distance_to: 0.0
    remove_alpha: false
    background_color: "white"

  # Data loader settings
  # Smaller batch due to limited real data
  dataloader:
    batch_size_per_gpu: 2
    num_workers: 4
    num_threads: 16
    prefetch_factor: 16

  # Loss function weights
  # Adjusted for real-world data
  losses:
    l2_loss_weight: 1.0
    lpips_loss_weight: 0.5        # Increase perceptual loss for real images
    perceptual_loss_weight: 0.5
    ssim_loss_weight: 0.2         # Enable SSIM for structural similarity
    pixelalign_loss_weight: 0.0
    masked_pixelalign_loss: true
    pointsdist_loss_weight: 0.0
    warmup_pointsdist: false
    distill_loss_weight: 0.0

  # Optimizer configuration (AdamW)
  optimizer:
    lr: 0.00005               # Lower LR for finetuning
    beta1: 0.9
    beta2: 0.95
    weight_decay: 0.05
    reset_lr: false
    reset_weight_decay: false
    reset_training_state: true

  # Training schedule
  schedule:
    num_epochs: 100000
    early_stop_after_epochs: 100000
    max_fwdbwd_passes: 10000      # Fewer passes for smaller dataset
    warmup: 200
    l2_warmup_steps: 200

  # Checkpointing
  checkpointing:
    # Start from Objaverse pretrained weights (Stage 2)
    # Or use face pretrained: "checkpoints/gslrm/stage_3"
    resume_ckpt: "checkpoints/gslrm/stage_2"
    checkpoint_every: 1000
    checkpoint_dir: "checkpoints/gslrm/mouse"

  # Logging and monitoring
  logging:
    print_every: 10
    vis_every: 100

    # Weights & Biases configuration
    wandb:
      project: "mouse_facelift"
      exp_name: "mouse_6view"
      group: "mouse"
      job_type: "train"
      log_every: 20
      offline: false

# =============================================================================
# Inference Configuration
# =============================================================================
inference:
  enabled: false
  output_dir: "experiments/inference/mouse"

# =============================================================================
# Validation Configuration
# =============================================================================
validation:
  enabled: true
  val_every: 500
  output_dir: "experiments/validation/mouse"
  dataset_path: "data_mouse/data_mouse_val.txt"

# =============================================================================
# Mouse-specific Settings
# =============================================================================
mouse:
  # Camera configuration (matches real setup)
  camera:
    num_views: 6
    # Default camera distance for mouse (adjust based on actual setup)
    camera_distance: 2.7

  # Preprocessing
  preprocessing:
    use_face_detection: false  # No face detection for mice
    auto_crop: false           # Use full masked image
    background_removal: true   # Use mask for background

  # Data augmentation for limited data
  augmentation:
    enabled: true
    horizontal_flip: true
    rotation_range: 5          # Small rotation augmentation
    brightness_range: [0.9, 1.1]
    contrast_range: [0.9, 1.1]
