# =============================================================================
# Mouse GS-LRM - Local RTX 3060 Training Config
# =============================================================================
# Target: RTX 3060 12GB (local machine)
# Data: data_mouse_local/ (real 6-view images, camera normalized)
#
# Key Changes from gpu05 config:
# 1. use_mouse_dataset: true → Fixed view order, avoids Plücker coord chaos
# 2. LPIPS/Perceptual: 0.0 → Mouse domain incompatible with ImageNet VGG
# 3. Camera normalization: MouseViewDataset handles distance=2.7, Z-up
# 4. Low memory settings for RTX 3060 12GB
# =============================================================================
profile: false
debug: false

model:
  class_name: gslrm.model.gslrm.GSLRM

  image_tokenizer:
    image_size: 384           # Balanced for RTX 3060 12GB (256 uses 60%, 512 OOM)
    patch_size: 8
    in_channels: 9            # RGB(3) + Plücker(6)

  transformer:
    d: 1024
    d_head: 64
    n_layer: 24

  gaussians:
    n_gaussians: 2
    sh_degree: 0
    upsampler:
      upsample_factor: 1

  add_refsrc_marker: false
  hard_pixelalign: true
  use_custom_plucker: true
  clip_xyz: true

training:
  runtime:
    use_tf32: false           # RTX 3060 doesn't support TF32
    use_amp: true
    amp_dtype: "fp16"         # fp16 better than bf16 on consumer GPUs
    torch_compile: false
    grad_accum_steps: 4       # Effective batch = 1 * 4 = 4
    grad_clip_norm: 1.0
    grad_checkpoint_every: 1  # Max memory saving

  dataset:
    # Preprocessed real mouse data (centered + uniform scaled)
    dataset_path: "data_mouse_uniform/data_mouse_train.txt"
    maximize_view_overlap: false
    num_views: 6
    # 5 input → 1 predict (similar difficulty to pretrained)
    num_input_views: 5
    target_has_input: true
    # Already normalized in data prep, or let MouseViewDataset handle it
    normalize_distance_to: 0.0
    remove_alpha: false       # Keep alpha if present
    background_color: "white"

  dataloader:
    batch_size_per_gpu: 1     # RTX 3060: 1 sample per step
    num_workers: 2            # Reduced for local machine
    num_threads: 8
    prefetch_factor: 4

  losses:
    l2_loss_weight: 1.0
    # CRITICAL: Disable for mouse domain (ImageNet pretrained, OOD)
    lpips_loss_weight: 0.0
    perceptual_loss_weight: 0.0
    # Safe losses only
    ssim_loss_weight: 0.5
    # Masked losses: Only compute on foreground (mask > 0.5)
    # This focuses learning on the mouse object, not background
    masked_l2_loss: true
    masked_ssim_loss: true
    # Clamp rendering to [0,1] before loss computation (safety measure)
    # Original FaceLift doesn't use this, but helps stabilize finetuning
    clamp_rendering: true
    # Pixel alignment disabled (weight=0)
    pixelalign_loss_weight: 0.0
    masked_pixelalign_loss: true
    pointsdist_loss_weight: 0.0
    warmup_pointsdist: false
    distill_loss_weight: 0.0

  optimizer:
    lr: 0.00002               # Low LR for fine-tuning
    beta1: 0.9
    beta2: 0.95
    weight_decay: 0.05
    reset_lr: true
    reset_weight_decay: false
    reset_training_state: true

  schedule:
    num_epochs: 50000
    early_stop_after_epochs: 50000
    max_fwdbwd_passes: 20000  # ~5 epochs for 3496 samples
    warmup: 100
    l2_warmup_steps: 100

  checkpointing:
    checkpoint_dir: "checkpoints/gslrm/mouse_local_rtx3060"
    checkpoint_every: 500
    # Use pretrained FaceLift checkpoint
    resume_ckpt: "checkpoints/gslrm/ckpt_0000000000021125.pt"

  logging:
    print_every: 10
    vis_every: 200            # Less frequent for memory
    wandb:
      project: "mouse_facelift"
      group: "gslrm_local"
      job_type: "finetune_rtx3060"
      exp_name: "mouse_gslrm_local_rtx3060_fixed_view"
      log_every: 20
      offline: false

mouse:
  # ==========================================================================
  # CRITICAL SETTINGS - DO NOT REMOVE
  # ==========================================================================
  # use_mouse_dataset: true
  #   - Uses MouseViewDataset instead of RandomViewDataset
  #   - Fixed view order [0,1,2,3,4,5] every step
  #   - Random view order causes Plücker coordinate inconsistency → blurry output
  #
  # Camera normalization:
  #   - Distance normalized to 2.7 (matches pretrained model)
  #   - Z-up coordinate system (matches human data)
  #
  # auto_generate_mask: true
  #   - CRITICAL for mouse images without alpha channel
  #   - Without mask: 95% of loss from background, 5% from mouse
  #   - With mask: Loss focuses on foreground (mouse) pixels only
  # ==========================================================================
  use_mouse_dataset: true

  # Camera normalization (applied by MouseViewDataset)
  normalize_cameras: true
  target_camera_distance: 2.7
  normalize_to_z_up: true

  # Auto mask generation from white background
  # Creates alpha channel where non-white pixels = 1 (foreground)
  auto_generate_mask: true
  mask_threshold: 250         # RGB values > 250 are considered background

  augmentation:
    enabled: false            # Disabled for finetuning (preserves pretrained distribution)
    brightness_range: [0.9, 1.1]
    contrast_range: [0.9, 1.1]
    hflip: false              # Asymmetric mouse anatomy

validation:
  enabled: true
  dataset_path: "data_mouse_uniform/data_mouse_val.txt"
  output_dir: "experiments/validation/mouse_gslrm_local_rtx3060"
  val_every: 500              # Every 500 steps

inference:
  enabled: false
  output_dir: "experiments/inference/mouse_gslrm_local_rtx3060"
