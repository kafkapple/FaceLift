# =============================================================================
# Mouse GS-LRM v2 - Mode Collapse 방지 설정
# 변경사항:
#   - lr: 1e-6 → 1e-5 (10x 증가)
#   - l2_warmup_steps: 500 → 0 (비활성화)
#   - perceptual_loss_weight: 0.5 → 1.0
#   - lpips_loss_weight: 0.5 → 1.0
#   - ssim_loss_weight: 0.2 → 0.5
# 목적: 흐릿해지는 출력 (mean regression) 문제 해결
# =============================================================================
profile: false
debug: false

model:
  class_name: gslrm.model.gslrm.GSLRM

  image_tokenizer:
    image_size: 512
    patch_size: 8
    in_channels: 9

  transformer:
    d: 1024
    d_head: 64
    n_layer: 24

  gaussians:
    n_gaussians: 2
    sh_degree: 0
    upsampler:
      upsample_factor: 1

  add_refsrc_marker: false
  hard_pixelalign: true
  use_custom_plucker: true
  clip_xyz: true

training:
  runtime:
    use_tf32: true
    use_amp: true
    amp_dtype: "bf16"
    torch_compile: false
    grad_accum_steps: 1
    grad_clip_norm: 1.0              # Gradient clipping threshold
    allowed_gradnorm_factor: 100     # Skip threshold = 1.0 * 100 = 100
    grad_checkpoint_every: 1

  dataset:
    dataset_path: "data_mouse/data_mouse_train.txt"
    maximize_view_overlap: false
    num_views: 6
    num_input_views: 1
    target_has_input: true
    normalize_distance_to: 0.0
    remove_alpha: false
    background_color: "white"

  dataloader:
    batch_size_per_gpu: 2
    num_workers: 4
    num_threads: 16
    prefetch_factor: 16

  # Loss weights - 강화된 perceptual loss로 선명도 유지
  losses:
    l2_loss_weight: 1.0
    lpips_loss_weight: 0.0           # 0.5 → 1.0 (2x 증가)
    perceptual_loss_weight: 1.0      # 0.5 → 1.0 (2x 증가)
    ssim_loss_weight: 0.5            # 0.2 → 0.5 (구조 보존)
    pixelalign_loss_weight: 0.0
    masked_pixelalign_loss: true
    pointsdist_loss_weight: 0.0
    warmup_pointsdist: false
    distill_loss_weight: 0.0

  # Optimizer - 중간 learning rate (1e-5는 너무 높음, 56% skip)
  optimizer:
    lr: 0.000005                     # 5e-06 (기존 1e-06의 5x)
    beta1: 0.9
    beta2: 0.95
    weight_decay: 0.05
    reset_lr: true
    reset_weight_decay: false
    reset_training_state: false

  schedule:
    num_epochs: 50000
    early_stop_after_epochs: 50000
    max_fwdbwd_passes: 50000
    warmup: 500
    l2_warmup_steps: 0               # 500 → 0 (L2 warmup 비활성화)

  checkpointing:
    checkpoint_dir: "checkpoints/gslrm/exp_a"
    checkpoint_every: 500
    resume_ckpt: "checkpoints/gslrm/ckpt_0000000000021125.pt"
    # auto_resume: true

  logging:
    print_every: 10
    vis_every: 100
    wandb:
      project: "mouse_facelift"
      group: "gslrm"
      job_type: "finetune_v2"
      exp_name: "exp_a_no_lpips"
      log_every: 20
      offline: false

# Mouse-specific settings
mouse:
  # Camera normalization: rotate all cameras so orbit axis aligns with Y-up
  normalize_cameras: true
  # Normalize camera distance to FaceLift expected value (2.7)
  target_camera_distance: 2.7

  augmentation:
    enabled: true
    brightness_range: [0.9, 1.1]
    contrast_range: [0.9, 1.1]
    hflip: false

validation:
  enabled: true
  dataset_path: "data_mouse/data_mouse_val.txt"
  output_dir: "experiments/validation/mouse_gslrm_v2"
  val_every: 500

inference:
  enabled: false
  output_dir: "experiments/inference/mouse_gslrm_v2"
