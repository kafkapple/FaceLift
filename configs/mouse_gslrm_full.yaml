# =============================================================================
# Mouse GS-LRM - Full Config (gpu05 A6000 48GB)
# Original FaceLift paper settings with mouse data
# =============================================================================
# This is the recommended config for high-VRAM GPUs (A6000, A100, etc.)
# Requires: ~20GB VRAM
#
# Key differences from lowmem:
#   - batch_size: 2 (vs 1)
#   - grad_accum_steps: 2 (vs 4)
#   - amp_dtype: bf16 (vs fp16)
#   - num_workers: 4, prefetch_factor: 8 (higher throughput)
#
# Loss Settings: Same as original FaceLift paper
#   - l2_loss: 1.0, perceptual_loss: 0.5
# =============================================================================
profile: false
debug: false

model:
  class_name: gslrm.model.gslrm.GSLRM

  image_tokenizer:
    image_size: 512
    patch_size: 8
    in_channels: 9

  transformer:
    d: 1024
    d_head: 64
    n_layer: 24

  gaussians:
    n_gaussians: 2
    sh_degree: 0
    upsampler:
      upsample_factor: 1

  add_refsrc_marker: false
  hard_pixelalign: true
  use_custom_plucker: true
  clip_xyz: true

training:
  runtime:
    use_tf32: true              # Enable TF32 (Ampere+ GPUs)
    use_amp: true
    amp_dtype: "bf16"           # bf16 for A6000/A100
    torch_compile: false
    grad_accum_steps: 2         # Original paper setting
    grad_clip_norm: 1.0
    grad_checkpoint_every: 1

  dataset:
    # Using normalized synthetic data (camera distance = 2.7)
    dataset_path: "data_mouse_synthetic_normalized/data_train.txt"
    maximize_view_overlap: false
    num_views: 6
    # CRITICAL: Use 5 input views to predict 1 (not 1→5)
    # Pretrained model: 6 input → 2 predict
    # Our setting: 5 input → 1 predict (similar difficulty)
    num_input_views: 5
    target_has_input: true
    # Already normalized to 2.7, no additional normalization needed
    normalize_distance_to: 0.0
    remove_alpha: true  # Synthetic data is RGB (not RGBA)
    background_color: "white"

  dataloader:
    batch_size_per_gpu: 2       # Original paper setting
    num_workers: 4
    num_threads: 16
    prefetch_factor: 8

  losses:
    l2_loss_weight: 1.0
    # Perceptual loss (VGG19-based) - original paper setting
    lpips_loss_weight: 0.0
    perceptual_loss_weight: 0.5    # Original paper: 0.5
    # SSIM loss (purely image-based, no learned features)
    ssim_loss_weight: 0.0          # Original paper: 0.0
    pixelalign_loss_weight: 0.0
    masked_pixelalign_loss: true
    pointsdist_loss_weight: 0.0
    warmup_pointsdist: false
    distill_loss_weight: 0.0

    # Mask options (original paper uses false for all)
    masked_l2_loss: false
    masked_ssim_loss: false

    # Background supervision (optional, not in original paper)
    background_loss_weight: 0.0
    background_color_target: [1.0, 1.0, 1.0]

  optimizer:
    lr: 0.00002
    beta1: 0.9
    beta2: 0.95
    weight_decay: 0.05
    reset_lr: true
    reset_weight_decay: false
    reset_training_state: true   # Reset step counter to start from 0

  schedule:
    num_epochs: 50000
    early_stop_after_epochs: 50000
    max_fwdbwd_passes: 10000     # Longer training for 2000 samples
    warmup: 50
    l2_warmup_steps: 50

  checkpointing:
    checkpoint_dir: "checkpoints/gslrm/mouse_full"
    checkpoint_every: 500
    resume_ckpt: "checkpoints/gslrm/ckpt_0000000000021125.pt"

  logging:
    print_every: 10
    vis_every: 100
    wandb:
      project: "mouse_facelift"
      group: "gslrm"
      job_type: "finetune_full"
      exp_name: "mouse_gslrm_full"
      log_every: 10
      offline: false

mouse:
  # CRITICAL: Must be true for mouse data!
  # - Enables MouseViewDataset with fixed view order [0,1,2,3,4,5]
  # - Random view order causes Plucker coordinate inconsistency -> blurry output
  use_mouse_dataset: true

  # Camera normalization (applied by MouseViewDataset)
  normalize_cameras: true           # Normalize to Z-up coordinate system
  target_camera_distance: 2.7       # Match pretrained model's camera radius
  normalize_to_z_up: true           # Z-up (matches human data pretrained model)

  augmentation:
    enabled: true
    brightness_range: [0.9, 1.1]
    contrast_range: [0.9, 1.1]
    hflip: false

validation:
  enabled: true
  dataset_path: "data_mouse_synthetic_normalized/data_val.txt"
  output_dir: "experiments/validation/mouse_gslrm_full"
  val_every: 200

inference:
  enabled: false
  output_dir: "experiments/inference/mouse_gslrm_full"
